{"version":3,"file":"parse-query.ts","sources":["/Users/alexbouhdary/Documents/GitHub/OS_design-directory/api/search/parse-query.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;GAUG;AAEH,OAAO,SAAS,MAAM,mBAAmB,CAAC;AAE1C,MAAM,CAAC,MAAM,MAAM,GAAG;IACpB,OAAO,EAAE,MAAM;CAChB,CAAC;AAEF;;GAEG;AACH,MAAM,WAAW,GAAG;IAClB,mBAAmB,EAAE,EAAE;IACvB,gBAAgB,EAAE,GAAG;CACtB,CAAC;AAEF;;;GAGG;AACH,MAAM,cAAc,GAAG,IAAI,GAAG,EAK1B,CAAC;AAEL;;GAEG;AACH,SAAS,cAAc,CAAC,EAAU;IAChC,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;IACvB,MAAM,MAAM,GAAG,cAAc,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI;QACvC,WAAW,EAAE,CAAC;QACd,eAAe,EAAE,GAAG,GAAG,KAAK,EAAO,WAAW;QAC9C,QAAQ,EAAE,CAAC;QACX,YAAY,EAAE,GAAG,GAAG,QAAQ,EAAO,WAAW;KAC/C,CAAC;IAEF,yCAAyC;IACzC,IAAI,GAAG,GAAG,MAAM,CAAC,eAAe,EAAE,CAAC;QACjC,MAAM,CAAC,WAAW,GAAG,CAAC,CAAC;QACvB,MAAM,CAAC,eAAe,GAAG,GAAG,GAAG,KAAK,CAAC;IACvC,CAAC;IAED,sCAAsC;IACtC,IAAI,GAAG,GAAG,MAAM,CAAC,YAAY,EAAE,CAAC;QAC9B,MAAM,CAAC,QAAQ,GAAG,CAAC,CAAC;QACpB,MAAM,CAAC,YAAY,GAAG,GAAG,GAAG,QAAQ,CAAC;IACvC,CAAC;IAED,eAAe;IACf,IAAI,MAAM,CAAC,WAAW,IAAI,WAAW,CAAC,mBAAmB,EAAE,CAAC;QAC1D,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,mDAAmD,EAAE,CAAC;IACzF,CAAC;IACD,IAAI,MAAM,CAAC,QAAQ,IAAI,WAAW,CAAC,gBAAgB,EAAE,CAAC;QACpD,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,0CAA0C,EAAE,CAAC;IAChF,CAAC;IAED,qBAAqB;IACrB,MAAM,CAAC,WAAW,EAAE,CAAC;IACrB,MAAM,CAAC,QAAQ,EAAE,CAAC;IAClB,cAAc,CAAC,GAAG,CAAC,EAAE,EAAE,MAAM,CAAC,CAAC;IAE/B,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;AAC3B,CAAC;AAED;;GAEG;AACH,MAAM,aAAa,GAAG;;;;;;;;;;;;;;;;;;sEAkBgD,CAAC;AAEvE;;GAEG;AACH,SAAS,eAAe,CAAC,KAAa;IACpC,OAAO,kDAAkD,KAAK;;;;;;;;;;;;;;;;;;;;;;;;;;;cA2BlD,KAAK,GAAG,CAAC;AACvB,CAAC;AAED,MAAM,CAAC,OAAO,CAAC,KAAK,UAAU,OAAO,CAAC,GAAY;IAChD,2BAA2B;IAC3B,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,EAAE,CAAC;QAC1B,OAAO,IAAI,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,oBAAoB,EAAE,CAAC,EAAE;YACnE,MAAM,EAAE,GAAG;YACX,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE;SAChD,CAAC,CAAC;IACL,CAAC;IAED,kCAAkC;IAClC,MAAM,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC,EAAE,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE;QACzD,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC;QAC5B,SAAS,CAAC;IAErB,mBAAmB;IACnB,MAAM,eAAe,GAAG,cAAc,CAAC,EAAE,CAAC,CAAC;IAC3C,IAAI,CAAC,eAAe,CAAC,OAAO,EAAE,CAAC;QAC7B,OAAO,IAAI,QAAQ,CACjB,IAAI,CAAC,SAAS,CAAC;YACb,KAAK,EAAE,eAAe,CAAC,MAAM;YAC7B,MAAM,EAAE,MAAM;YACd,OAAO,EAAE,EAAE;YACX,QAAQ,EAAE,EAAE;YACZ,aAAa,EAAE,EAAE;YACjB,UAAU,EAAE,KAAK;SAClB,CAAC,EACF;YACE,MAAM,EAAE,GAAG;YACX,OAAO,EAAE;gBACP,cAAc,EAAE,kBAAkB;gBAClC,aAAa,EAAE,IAAI;aACpB;SACF,CACF,CAAC;IACJ,CAAC;IAED,qBAAqB;IACrB,IAAI,KAAa,CAAC;IAClB,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC;QAC9B,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC;QAEnB,IAAI,CAAC,KAAK,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE,CAAC;YACxC,OAAO,IAAI,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,yBAAyB,EAAE,CAAC,EAAE;gBACxE,MAAM,EAAE,GAAG;gBACX,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE;aAChD,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAAC,MAAM,CAAC;QACP,OAAO,IAAI,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,mBAAmB,EAAE,CAAC,EAAE;YAClE,MAAM,EAAE,GAAG;YACX,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE;SAChD,CAAC,CAAC;IACL,CAAC;IAED,oBAAoB;IACpB,MAAM,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC,iBAAiB,CAAC;IAC7C,IAAI,CAAC,MAAM,EAAE,CAAC;QACZ,OAAO,IAAI,QAAQ,CACjB,IAAI,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,wBAAwB,EAAE,CAAC,EACnD;YACE,MAAM,EAAE,GAAG;YACX,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE;SAChD,CACF,CAAC;IACJ,CAAC;IAED,IAAI,CAAC;QACH,8BAA8B;QAC9B,MAAM,SAAS,GAAG,IAAI,SAAS,CAAC;YAC9B,MAAM;SACP,CAAC,CAAC;QAEH,0DAA0D;QAC1D,MAAM,QAAQ,GAAG,MAAM,SAAS,CAAC,QAAQ,CAAC,MAAM,CAAC;YAC/C,KAAK,EAAE,0BAA0B;YACjC,UAAU,EAAE,GAAG;YACf,MAAM,EAAE,aAAa;YACrB,QAAQ,EAAE;gBACR;oBACE,IAAI,EAAE,MAAM;oBACZ,OAAO,EAAE,eAAe,CAAC,KAAK,CAAC;iBAChC;aACF;SACF,CAAC,CAAC;QAEH,uBAAuB;QACvB,MAAM,WAAW,GAAG,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC;QAClE,IAAI,CAAC,WAAW,IAAI,WAAW,CAAC,IAAI,KAAK,MAAM,EAAE,CAAC;YAChD,MAAM,IAAI,KAAK,CAAC,8BAA8B,CAAC,CAAC;QAClD,CAAC;QAED,0BAA0B;QAC1B,IAAI,MAAM,CAAC;QACX,IAAI,CAAC;YACH,0CAA0C;YAC1C,IAAI,QAAQ,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC;YACvC,IAAI,QAAQ,CAAC,UAAU,CAAC,KAAK,CAAC,EAAE,CAAC;gBAC/B,QAAQ,GAAG,QAAQ,CAAC,OAAO,CAAC,cAAc,EAAE,EAAE,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;YAC9E,CAAC;YACD,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC;QAChC,CAAC;QAAC,OAAO,UAAU,EAAE,CAAC;YACpB,OAAO,CAAC,KAAK,CAAC,kCAAkC,EAAE,WAAW,CAAC,IAAI,CAAC,CAAC;YACpE,MAAM,IAAI,KAAK,CAAC,0BAA0B,CAAC,CAAC;QAC9C,CAAC;QAED,0BAA0B;QAC1B,OAAO,IAAI,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE;YAC1C,MAAM,EAAE,GAAG;YACX,OAAO,EAAE;gBACP,cAAc,EAAE,kBAAkB;gBAClC,eAAe,EAAE,uBAAuB,EAAE,mBAAmB;aAC9D;SACF,CAAC,CAAC;IACL,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,OAAO,CAAC,KAAK,CAAC,mBAAmB,EAAE,KAAK,CAAC,CAAC;QAE1C,qDAAqD;QACrD,OAAO,IAAI,QAAQ,CACjB,IAAI,CAAC,SAAS,CAAC;YACb,MAAM,EAAE,MAAM;YACd,OAAO,EAAE,EAAE;YACX,QAAQ,EAAE,EAAE;YACZ,aAAa,EAAE,CAAC,KAAK,CAAC;YACtB,UAAU,EAAE,KAAK;YACjB,KAAK,EAAE,oBAAoB;SAC5B,CAAC,EACF;YACE,MAAM,EAAE,GAAG,EAAE,mDAAmD;YAChE,OAAO,EAAE,EAAE,cAAc,EAAE,kBAAkB,EAAE;SAChD,CACF,CAAC;IACJ,CAAC;AACH,CAAC","sourcesContent":["/**\n * Vercel Edge Function for LLM Query Parsing\n *\n * Securely proxies Claude API calls to parse search queries\n * into structured filters and semantic concepts.\n *\n * Features:\n * - Claude Sonnet for high-quality query understanding\n * - Per-IP rate limiting (10 req/min, 100 req/day)\n * - Graceful fallback on errors\n */\n\nimport Anthropic from '@anthropic-ai/sdk';\n\nexport const config = {\n  runtime: 'edge',\n};\n\n/**\n * Rate limiting configuration\n */\nconst RATE_LIMITS = {\n  REQUESTS_PER_MINUTE: 10,\n  REQUESTS_PER_DAY: 100,\n};\n\n/**\n * In-memory rate limit tracking (resets on cold start)\n * For production, consider using Vercel KV or Redis\n */\nconst rateLimitStore = new Map<string, {\n  minuteCount: number;\n  minuteResetTime: number;\n  dayCount: number;\n  dayResetTime: number;\n}>();\n\n/**\n * Check and update rate limits for an IP\n */\nfunction checkRateLimit(ip: string): { allowed: boolean; reason?: string } {\n  const now = Date.now();\n  const record = rateLimitStore.get(ip) || {\n    minuteCount: 0,\n    minuteResetTime: now + 60000,      // 1 minute\n    dayCount: 0,\n    dayResetTime: now + 86400000,      // 24 hours\n  };\n\n  // Reset minute counter if window expired\n  if (now > record.minuteResetTime) {\n    record.minuteCount = 0;\n    record.minuteResetTime = now + 60000;\n  }\n\n  // Reset day counter if window expired\n  if (now > record.dayResetTime) {\n    record.dayCount = 0;\n    record.dayResetTime = now + 86400000;\n  }\n\n  // Check limits\n  if (record.minuteCount >= RATE_LIMITS.REQUESTS_PER_MINUTE) {\n    return { allowed: false, reason: 'Rate limit exceeded: too many requests per minute' };\n  }\n  if (record.dayCount >= RATE_LIMITS.REQUESTS_PER_DAY) {\n    return { allowed: false, reason: 'Rate limit exceeded: daily limit reached' };\n  }\n\n  // Increment counters\n  record.minuteCount++;\n  record.dayCount++;\n  rateLimitStore.set(ip, record);\n\n  return { allowed: true };\n}\n\n/**\n * System prompt for query parsing\n */\nconst SYSTEM_PROMPT = `You are a search query parser for a design tool directory. Your job is to understand user queries and extract structured filters and semantic concepts.\n\nAvailable data fields to filter on:\n- category: \"Tools\", \"AI\", \"Templates\", \"Learning\", \"Inspiration\", \"Community\"\n- subCategory: \"Design\", \"Development\", \"Productivity\", \"Generative\", \"Assets\", \"Guides\", \"Galleries\", etc.\n- pricing: \"Free\", \"Freemium\", \"Paid\", \"Pay per use\"\n- gravityScore: 7.5 to 9.8 (higher = more important/popular, like a rating)\n- tags: design, prototyping, ai, video, animation, icons, collaboration, react, etc.\n- featured: true/false\n- opensource: true/false\n\nIntent types:\n- \"filter\": User wants to narrow down results by specific criteria\n- \"find\": User is looking for tools that serve a specific purpose\n- \"compare\": User wants alternatives to a specific tool\n- \"explore\": User is browsing/discovering without specific criteria\n- \"recommend\": User wants suggestions based on a use case\n\nIMPORTANT: Respond with ONLY valid JSON, no markdown, no code blocks.`;\n\n/**\n * Build the user prompt for parsing\n */\nfunction buildUserPrompt(query: string): string {\n  return `Parse this search query into structured JSON: \"${query}\"\n\nReturn JSON with this structure:\n{\n  \"intent\": \"filter\" | \"find\" | \"compare\" | \"explore\" | \"recommend\",\n  \"filters\": {\n    \"pricing\": [\"Free\"] (optional array),\n    \"categories\": [\"Tools\"] (optional array),\n    \"subCategories\": [\"Design\"] (optional array),\n    \"minGravityScore\": 9 (optional number),\n    \"maxGravityScore\": 10 (optional number),\n    \"tags\": [\"design\"] (optional array),\n    \"featured\": true (optional boolean),\n    \"opensource\": true (optional boolean)\n  },\n  \"concepts\": [\"concept1\", \"concept2\"] (semantic concepts for soft matching),\n  \"semanticTerms\": [\"term1\"] (original terms for fallback),\n  \"confidence\": \"high\" | \"medium\" | \"low\",\n  \"comparisonTarget\": \"Figma\" (optional, for comparison queries),\n  \"explanation\": \"Brief explanation\" (optional)\n}\n\nExamples:\n- \"free tools rated over 9\" → {\"intent\":\"filter\",\"filters\":{\"pricing\":[\"Free\"],\"minGravityScore\":9},\"concepts\":[],\"semanticTerms\":[\"tools\"],\"confidence\":\"high\"}\n- \"mood board tools\" → {\"intent\":\"find\",\"filters\":{},\"concepts\":[\"visual inspiration\",\"design curation\",\"image collection\",\"pinterest-like\",\"collage\",\"moodboard\"],\"semanticTerms\":[\"mood board\"],\"confidence\":\"medium\"}\n- \"alternatives to Figma\" → {\"intent\":\"compare\",\"filters\":{\"categories\":[\"Tools\"]},\"concepts\":[\"design tool\",\"ui design\",\"prototyping\"],\"semanticTerms\":[],\"confidence\":\"high\",\"comparisonTarget\":\"Figma\"}\n\nNow parse: \"${query}\"`;\n}\n\nexport default async function handler(req: Request): Promise<Response> {\n  // Only allow POST requests\n  if (req.method !== 'POST') {\n    return new Response(JSON.stringify({ error: 'Method not allowed' }), {\n      status: 405,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  }\n\n  // Get client IP for rate limiting\n  const ip = req.headers.get('x-forwarded-for')?.split(',')[0]?.trim() ||\n             req.headers.get('x-real-ip') ||\n             'unknown';\n\n  // Check rate limit\n  const rateLimitResult = checkRateLimit(ip);\n  if (!rateLimitResult.allowed) {\n    return new Response(\n      JSON.stringify({ \n        error: rateLimitResult.reason,\n        intent: 'find',\n        filters: {},\n        concepts: [],\n        semanticTerms: [],\n        confidence: 'low',\n      }),\n      {\n        status: 429,\n        headers: { \n          'Content-Type': 'application/json',\n          'Retry-After': '60',\n        },\n      }\n    );\n  }\n\n  // Parse request body\n  let query: string;\n  try {\n    const body = await req.json();\n    query = body.query;\n\n    if (!query || typeof query !== 'string') {\n      return new Response(JSON.stringify({ error: 'Invalid query parameter' }), {\n        status: 400,\n        headers: { 'Content-Type': 'application/json' },\n      });\n    }\n  } catch {\n    return new Response(JSON.stringify({ error: 'Invalid JSON body' }), {\n      status: 400,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  }\n\n  // Check for API key\n  const apiKey = process.env.ANTHROPIC_API_KEY;\n  if (!apiKey) {\n    return new Response(\n      JSON.stringify({ error: 'API key not configured' }),\n      {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' },\n      }\n    );\n  }\n\n  try {\n    // Initialize Anthropic client\n    const anthropic = new Anthropic({\n      apiKey,\n    });\n\n    // Call Claude Sonnet for high-quality query understanding\n    const response = await anthropic.messages.create({\n      model: 'claude-sonnet-4-20250514',\n      max_tokens: 500,\n      system: SYSTEM_PROMPT,\n      messages: [\n        {\n          role: 'user',\n          content: buildUserPrompt(query),\n        },\n      ],\n    });\n\n    // Extract text content\n    const textContent = response.content.find(c => c.type === 'text');\n    if (!textContent || textContent.type !== 'text') {\n      throw new Error('No text response from Claude');\n    }\n\n    // Parse the JSON response\n    let parsed;\n    try {\n      // Clean up potential markdown code blocks\n      let jsonText = textContent.text.trim();\n      if (jsonText.startsWith('```')) {\n        jsonText = jsonText.replace(/```json?\\n?/g, '').replace(/```$/g, '').trim();\n      }\n      parsed = JSON.parse(jsonText);\n    } catch (parseError) {\n      console.error('Failed to parse Claude response:', textContent.text);\n      throw new Error('Invalid JSON from Claude');\n    }\n\n    // Return the parsed query\n    return new Response(JSON.stringify(parsed), {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'public, s-maxage=3600', // Cache for 1 hour\n      },\n    });\n  } catch (error) {\n    console.error('Claude API error:', error);\n\n    // Return a fallback response that the client can use\n    return new Response(\n      JSON.stringify({\n        intent: 'find',\n        filters: {},\n        concepts: [],\n        semanticTerms: [query],\n        confidence: 'low',\n        error: 'LLM parsing failed',\n      }),\n      {\n        status: 200, // Return 200 with fallback so client doesn't crash\n        headers: { 'Content-Type': 'application/json' },\n      }\n    );\n  }\n}\n"]}